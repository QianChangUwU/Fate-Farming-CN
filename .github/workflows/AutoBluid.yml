name: AutoBuild

on:
  push:
    branches: ["main"]
    paths-ignore:
      - ".github/workflows/**"
      - "README.md"
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# 权限设置：仅授予发布/内容操作权限
permissions:
  contents: write

# 防止并发冲突，如果有新的运行，自动取消旧的运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 生成标签（使用环境变量和变量输出）
      - name: Generate unique tag
        id: vars
        run: |
          export TZ="Asia/Shanghai"
          TAG="Fate_Farming_3.1.5_CN-1.4.0_$(date +'%Y%m%d_%H%M%S')"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "CURRENT_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV

      # 3. 清理旧 Release (使用 GitHub CLI，速度更快)
      - name: Cleanup old releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for releases on or before ${{ env.CURRENT_DATE }}..."
          # 获取所有 release 标签名并在本地筛选
          gh release list --limit 100 | while read -r line; do
            TAG_NAME=$(echo "$line" | awk '{print $1}')
            # 提取标签中的日期部分 (假设格式包含 8 位数字)
            RELEASE_DATE=$(echo "$TAG_NAME" | grep -oP '\d{8}' | head -n 1)
            
            if [[ -n "$RELEASE_DATE" && "$RELEASE_DATE" -le "${{ env.CURRENT_DATE }}" ]]; then
              echo "Deleting old release and tag: $TAG_NAME"
              gh release delete "$TAG_NAME" --yes --cleanup-tag
            fi
          done

      # 4. 打包代码
      - name: Create ZIP archive
        run: |
          ZIP_NAME="${{ env.TAG }}.zip"
          zip -r "$ZIP_NAME" . -x '.git/*' -x '.github/*'
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # 5. 创建 Release 并上传
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: ${{ env.TAG }}
          name: "自动构建 - ${{ env.TAG }}"
          body: |
            ## 构建信息
            - **构建时间**: ${{ env.CURRENT_DATE }}
          generate_release_notes: false
